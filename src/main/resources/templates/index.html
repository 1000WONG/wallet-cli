<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>tron block chain explorer</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <script src="/static/js/jquery.js"></script>
  <script src="/static/cryptohash/lib/elliptic.min.js"></script>
  <script src="/static/cryptohash/lib/sha.js"></script>
  <script src="/static/cryptohash/lib/sha1.js"></script>
  <script src="/static/cryptohash/lib/sha3.js"></script>
  <script src="/static/cryptohash/lib/sha3-256.js"></script>
  <script src="/static/cryptohash/lib/sha256.js"></script>
  <script src="/static/cryptohash/lib/sha512.js"></script>
  <script src="/static/cryptohash/lib/sha_dev.js"></script>
  <script src="/static/protolib/protobuf.js"></script>
  <script src="/static/tronjslib/contract.js"></script>
  <script src="/static/tronjslib/tron.js"></script>
  <script src="/static/tronjslib/troninv.js"></script>
  <script src="/static/utils/code.js"></script>
  <script src="/static/cryptohash/crypto.js"></script>


  <script type="text/javascript" th:inline="javascript">

    /*<![CDATA[*/

    $(function () {

      $("#queryAccount").on('click', function () {

        $.ajax({
          type: 'get',
          dataType: 'json',
          // url:'http：localhost:8088/alTest', contentType:"application/x-protobuf;charset=utf-8", // application/json
          // contentType:"application/x-protobuf;charset=utf-8",
          url:/*[[@{/alTest}]]*/,

          success: function (data) {

            var bytes = stringToBytes(data);
            var bytsDecode = base64Decode(bytes);
            console.log("base64String " + bytesToString(data));

            var t = proto.protocol.Account.deserializeBinary(bytsDecode);

            console.log("name " + t.getAccountName());
            console.log("address " + t.getAddress());
            var address = t.getAddress();
            var addressString = byteArray2hexStr(address);
            console.log("addressString " + addressString);

          }
        });

      });

      //send account and address
      var priKeyBytes;
      var addressBytes;
      var address;
      var accountName;

      $("#accountName1").focus(function () {
        $("#accountName1").css("background-color", "#FFFFCC");

        priKeyBytes = genPriKey();

        addressBytes = getAddressFromPriKey(priKeyBytes);
        address = byteArray2hexStr(addressBytes)

        $("#addressName1").val(address);
      });
      $("#accountName1").blur(function () {
        $("#accountName1").css("background-color", "#D6D6FF");
        accountName = $("#accountName1").val();

        //TODO fix privateKey store
        $("#privateKey").val(priKeyBytes);

      });

      $("#register").on('click', function () {

        $.ajax({
          type: 'post',
          data: {address: address, name: accountName, accountType: 0},
          dataType: 'json',
          // url:'http：localhost:8088/alTest', contentType:"application/x-protobuf;charset=utf-8", // application/json
          // contentType:"application/x-protobuf;charset=utf-8",
          url:/*[[@{/transactionForView}]]*/,

          success: function (data) {
            var rawDataBytes = getRowBytesFromTransactionBase64(data);

            var prikeyBytes = $("#privateKey").val();

            //doSign
            var signbytes = doSign(prikeyBytes, data);
            console.log("sign::: " + byteArray2hexStr(signbytes));

            var bytesss = getRowBytesFromTransactionBase64(data);
            console.log("row Data::: " + byteArray2hexStr(bytesss));
            var bytes = stringToBytes(data);
            var bytesDecode = base64Decode(bytes);
            console.log("base64String " + bytesToString(data));

            var transaction = proto.protocol.Transaction.deserializeBinary(bytesDecode);
            //toDO: assert ret is SUCESS
            var raw = transaction.getRawData();
            var type = raw.getType();
            var contract = raw.getContractList();
            var size = contract.length;
            var oneContract = contract[0];
            var any = oneContract.getParameter();
            var contarcType = oneContract.getType();
            var unpack = proto.google.protobuf.Any.prototype.unpack;
            var account = any.unpack(proto.protocol.AccountCreateContract.deserializeBinary,
                "protocol.AccountCreateContract");
            var accountType = account.getType();
            var accountName = account.getAccountName();
            var ownerAddress = account.getOwnerAddress();

            alert("please confirm your account : "+ bytesToString(accountName) + " and address : " + byteArray2hexStr(ownerAddress) );

            //set sign
            transaction.addSignature(signbytes);
            var tx = byteArray2hexStr(transaction);

            $.ajax({
              type: 'post',
              dataType: 'json',
              data: {transactionData: tx},
              url:/*[[@{/transactionFromView}]]*/,
              async:false,
              success: function (data) {
                if(data==true){
                  alert("tx : "+data);
                  alert("register is : " + result);
                }

              }
            });
          }
        });

      });

    });




    /*]]>*/

  </script>

</head>
<body>
<script type="text/javascript">
  testParseTransaction();
</script>

<div class="uk-navbar uk-navbar-attached">
  <div class="uk-container uk-container-center">
    <a href="/" class="uk-navbar-brand"><i class="uk-icon-bitcoin"></i> Tron Block Chain</a>
    <ul class="uk-navbar-nav">
      <li><a target="_blank" href="https://tron.network/">Tron's official website</a></li>
      <li><a target="_blank" href="https://github.com/tronprotocol">Tron's github </a></li>
      <li><a target="_blank" href="/queryAccount">account List </a></li>
      <li><a target="_blank" href="/queryWitness">witness List </a></li>
    </ul>
  </div>
</div>

<div align="center">
  <h1>Query Balance</h1>
  <form action="#" th:action="@{/balance}" th:object="${accountVo}" method="post">
    <p>
      address: <input type="text" th:field="*{address}"/>
    </p>
    <p>
      <input type="submit" value="query"/>
      <input type="reset" value="Reset"/>
    </p>
  </form>
</div>

<div align="center">
  <h1>Register Account</h1>
  <form action="#" th:action="@{/register}" th:object="${accountVo}" method="post">
    <p>
      name: <input id="accountName" type="text" th:field="*{name}"/>
      address: <input id="addressName" type="text" th:field="*{address}" readonly="readonly"/>
    </p>
    <p>
      <input id="query" type="submit" value="Commit"/>
      <input type="reset" value="Reset"/>
    </p>
  </form>
</div>


<div align="center">
  <h1>Register Account</h1>
  <form>
    <p>
      name: <input id="accountName1" type="text"/>
      address: <input id="addressName1" type="text" readonly="readonly"/>
    </p>
    <p>
      <input id="register" type="button" value="register"/>
      <input type="reset" value="Reset"/>
    </p>
  </form>
</div>


<div>
  <button id="queryAccount" type="button">query</button>
  <div id="name"></div>
</div>

<!--// TODO fix privateKey store-->
<div id="privateKey" hidden="hidden"></div>

<script type="text/javascript">
  function login() {
    $("#tobyte").val(stringToBytes($("#password").val()));
    var password = $("#password").val(); //String
    var priKeyBytes = hexStr2byteArray(password);
    var addr = getAddressFromPriKey(priKeyBytes);

    var addrHex = byteArray2hexStr(addr);

    $("#Address").val(addrHex);

    var pubkey = getPubKeyFromPriKey(stringToBytes($("#password").val()));
    var a = byteArray2hexStr(pubkey);

    $("#PubKey").val(a);
    $.ajax({

      type: "POST",//方法类型
      dataType: "json",//预期服务器返回的数据类型
      url: "/sendcoin2",//url
      data: $('#form1').serialize(),

      success: function (transaction) {
        console.log(transaction);//打印服务端返回的数据(调试用)
        transaction = doSign(priKeyBytes, transaction);
        //var txbytes = transaction.toByteArray();
        var tx = byte2hexStr(transaction);
        $.ajax({

          type: "POST",//方法类型
          dataType: "json",//预期服务器返回的数据类型
          url: "/sendTransaction",//url
          data: tx,

          success: function (result) {
            if (result == true) {

              alert("转账成功");
            }
          },
          error: function () {
            alert("异常！");
          }
        });
      },
      error: function () {
        alert("异常！");
      }
    });
  }
</script>
<div align="center">
  <h1>Send Coin</h1>
  <form action="##" method="post" id="form1">
    <input hidden="hidden" name="tobyte" id="tobyte"/>
    <input hidden="hidden" name="Address" id="Address"/>
    <input hidden="hidden" name="PubKey" id="PubKey"/>


    <p>
      ownAddress: <input id="password" name="password" type="text"/>
      toAddress: <input id="toAddress" name="toAddress" type="text"/>

      amount: <input id="Amount" name="Amount" type="text"/>

    </p>
    <p>
      <input id="send" type="button" value="commit" onclick="login()"/>
    </p>
  </form>
</div>
<script type="text/javascript">
  function login() {
    $("#tobyte").val(stringToBytes($("#password").val()));
    var password = $("#password").val(); //String
    var priKeyBytes = hexStr2byteArray(password);
    var addr = getAddressFromPriKey(priKeyBytes);

    var addrHex = byteArray2hexStr(addr);

    $("#Address").val(addrHex);

    var pubkey = getPubKeyFromPriKey(stringToBytes($("#password").val()));
    var a = byteArray2hexStr(pubkey);

    $("#PubKey").val(a);
    $.ajax({

      type: "POST",//方法类型
      dataType: "json",//预期服务器返回的数据类型
      url: "/sendcoin2",//url
      data: $('#form1').serialize(),
      async: false,

      success: function (transaction) {
        console.log(transaction);//打印服务端返回的数据(调试用)
        transaction = doSign(priKeyBytes, transaction);
        //var txbytes = transaction.toByteArray();
        //var tx = byte2hexStr(transaction);

        var tx = byteArray2hexStr(transaction);
        $.ajax({

          type: "POST",
          dataType: "json",
          url: "/sendTransaction",//url
          data: {tx: tx},
          async: false,

          success: function (result) {
            if (result != null) {

              alert(" tx is : " + result);
              alert("转账成功");
            }
          },
          error: function () {
            alert("异常！");
          }
        });
      },
      error: function () {
        alert("异常！");
      }
    });
  }
</script>
</body>
</html>